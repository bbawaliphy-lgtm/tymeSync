<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeSync - Find Common Class Time</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            color: #666;
            font-size: 1.1em;
        }

        .step {
            margin-bottom: 30px;
        }

        .step h2 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button.secondary {
            background: #6c757d;
        }

        .share-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .share-box input {
            flex: 1;
            cursor: text;
            user-select: all;
        }

        .share-box input:focus {
            background: #f0f4ff;
        }

        .day-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .day-navigation span {
            font-weight: bold;
            font-size: 1.2em;
        }

        .calendar {
            margin: 20px 0;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .time-slot {
            padding: 12px 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .time-slot:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .time-slot.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .live-stats {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .result-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .result-item.best {
            border-color: #28a745;
            background: #d4edda;
        }

        .availability-count {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
        }

        .confirmation {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .event-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .error-msg {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .event-history-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-history-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateX(5px);
        }

        .event-history-item h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .event-history-item p {
            margin: 0;
            font-size: 0.85em;
            color: #666;
        }

        .event-history-item .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .event-history-item .delete-btn:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .time-slots-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .day-navigation {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .time-slots-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üïê TimeSync</h1>
            <p>Find the perfect common time for your online classes</p>
        </header>

        <div id="step1" class="step">
            <h2>Step 1: Create Your Class Event</h2>

            <div class="form-group">
                <label>Your Email (to access your events from any device):</label>
                <input type="email" id="userEmail" placeholder="e.g., teacher@example.com" required>
            </div>

            <div class="form-group">
                <label>Class/Batch Name:</label>
                <input type="text" id="className" placeholder="e.g., Batch 2024 Mathematics" required>
            </div>
            <div class="form-group">
                <label>Session Duration:</label>
                <select id="duration">
                    <option value="1">1 hour</option>
                    <option value="1.5">1.5 hours</option>
                    <option value="2">2 hours</option>
                </select>
            </div>
            <button id="createEventBtn">Create Event & Get Share Link</button>

            <div id="eventHistorySection" style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #e9ecef;">
                <h3 style="margin-bottom: 15px; color: #666;">üìã Your Events</h3>
                <div class="form-group">
                    <label>Enter your email to view your events:</label>
                    <input type="email" id="historyEmail" placeholder="e.g., teacher@example.com">
                    <button id="loadHistoryBtn" style="margin-top: 10px;">Load My Events</button>
                </div>
                <div id="eventHistory" style="margin-top: 20px;"></div>
            </div>

            <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #e9ecef;">
                <h3 style="margin-bottom: 15px; color: #666;">üîç Access Event by ID</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Enter Event ID shared by someone else</p>
                <div class="form-group">
                    <input type="text" id="existingEventId" placeholder="e.g., event_1730544000000">
                </div>
                <button id="accessEventBtn" class="secondary">Access Event</button>
            </div>
        </div>

        <div id="step2" class="step" style="display: none;">
            <h2>Step 2: Share This Link With Students</h2>

            <div class="event-info" style="margin-bottom: 20px;">
                <h3 id="eventName" style="margin-bottom: 10px;"></h3>
                <p><strong>Event ID:</strong> <span id="displayEventId"></span></p>
                <p style="font-size: 0.9em; color: #666; margin-top: 5px;">Save this Event ID to access responses from any device!</p>
            </div>

            <div class="share-box">
                <input type="text" id="shareLink" readonly>
                <button id="copyLinkBtn">Copy Link</button>
            </div>

            <div class="live-stats">
                <h3>üìä Live Responses: <span id="responseCount">0</span> students</h3>
            </div>

            <button id="viewResultsBtn">View Live Results</button>
            <button id="resetAppBtn" class="secondary">Create New Event</button>
        </div>

        <div id="studentView" class="step" style="display: none;">
            <h2>Mark Your Available Times</h2>
            <p class="event-info" id="eventInfo"></p>

            <div class="day-navigation">
                <button id="prevDayBtn">‚Üê Previous Day</button>
                <span id="currentDay">Monday</span>
                <button id="nextDayBtn">Next Day ‚Üí</button>
            </div>

            <div class="calendar">
                <h3>Select your available time slots (6:00 AM - 11:00 PM):</h3>
                <div class="time-slots" id="timeSlots"></div>
            </div>

            <div class="form-group">
                <label>Your Name:</label>
                <input type="text" id="studentName" placeholder="Enter your name" required>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">üí° Use the same name if you want to update your availability later</p>
            </div>

            <button id="submitAvailabilityBtn">Submit My Availability</button>
            <div id="confirmation" class="confirmation" style="display: none;">
                <p>‚úÖ Thank you! Your availability has been recorded.</p>
            </div>

            <div id="editNotification" class="event-info" style="display: none; margin-top: 20px;">
                <p>‚úèÔ∏è You have already submitted your availability. You can update it by submitting again.</p>
            </div>
        </div>

        <div id="resultsView" class="step" style="display: none;">
            <h2>Best Time Slots for Your Class</h2>
            <div class="live-stats">
                <h3>üìä Total Responses: <span id="totalResponses">0</span> students</h3>
            </div>

            <div style="margin-bottom: 30px;">
                <button id="showStudentListBtn" class="secondary" style="margin: 10px 0;">üë• Show All Students</button>
                <div id="studentListContainer" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px;">
                    <h3 style="margin-bottom: 15px;">Students Who Responded:</h3>
                    <div id="studentList"></div>
                </div>
            </div>

            <div id="resultsContainer"></div>
            <button id="goBackBtn" class="secondary">Back to Event</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            doc,
            setDoc,
            getDoc,
            addDoc,
            onSnapshot,
            query,
            where,
            getDocs,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAz9_ZMs3pHCqcJsdiWNuozaFU30ISNmmA",
            authDomain: "timesync-app-4193b.firebaseapp.com",
            projectId: "timesync-app-4193b",
            storageBucket: "timesync-app-4193b.firebasestorage.app",
            messagingSenderId: "813960878803",
            appId: "1:813960878803:web:19e7b9f46f2d94b7239226"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentEvent = null;
        let currentDayIndex = 0;
        let currentUserEmail = null;
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        let selectedSlots = {};

        days.forEach(day => {
            selectedSlots[day] = [];
        });

        // Save/load user email from localStorage for convenience
        function saveUserEmail(email) {
            localStorage.setItem('timesync_user_email', email);
            currentUserEmail = email;
        }

        function loadUserEmail() {
            const email = localStorage.getItem('timesync_user_email');
            if (email) {
                currentUserEmail = email;
                document.getElementById('userEmail').value = email;
                document.getElementById('historyEmail').value = email;
            }
        }

        // Load events for a user from Firebase
        async function loadUserEvents(email) {
            if (!email) {
                alert('Please enter your email');
                return;
            }

            const normalizedEmail = email.toLowerCase().trim();

            try {
                const q = query(
                    collection(db, 'events'),
                    where('ownerEmail', '==', normalizedEmail)
                );
                const snapshot = await getDocs(q);

                const events = [];
                snapshot.forEach((doc) => {
                    events.push({ id: doc.id, ...doc.data() });
                });

                // Sort by creation date (newest first)
                events.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                displayEventHistory(events);
                saveUserEmail(normalizedEmail);

            } catch (error) {
                console.error("Error loading events:", error);
                alert('Error loading events: ' + error.message);
            }
        }

        // Display event history
        function displayEventHistory(events) {
            const historyContainer = document.getElementById('eventHistory');

            if (events.length === 0) {
                historyContainer.innerHTML = '<p style="color: #666; padding: 15px; text-align: center;">No events found for this email.</p>';
                return;
            }

            historyContainer.innerHTML = '';

            events.forEach((event) => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-history-item';

                const eventInfo = document.createElement('div');
                eventInfo.style.flex = '1';
                eventInfo.innerHTML = `
                    <h4>${event.name}</h4>
                    <p>Created: ${new Date(event.createdAt).toLocaleString()}</p>
                    <p style="font-size: 0.8em; color: #999;">ID: ${event.id}</p>
                `;

                eventInfo.onclick = () => loadExistingEvent(event.id);

                eventItem.appendChild(eventInfo);
                historyContainer.appendChild(eventItem);
            });
        }

        function generateTimeSlots() {
            const slots = [];
            for (let hour = 6; hour <= 23; hour++) {
                const timeString = formatTime(hour);
                const nextHour = hour === 23 ? 0 : hour + 1;
                const nextTimeString = formatTime(nextHour);
                slots.push({
                    time: `${timeString} - ${nextTimeString}`,
                    startHour: hour
                });
            }
            return slots;
        }

        const timeSlots = generateTimeSlots();

        function formatTime(hour) {
            if (hour === 0) return '12 AM';
            if (hour === 12) return '12 PM';
            if (hour < 12) return `${hour} AM`;
            return `${hour - 12} PM`;
        }

        async function createClassEvent() {
            console.log("Creating event...");

            const userEmail = document.getElementById('userEmail').value.trim();
            const className = document.getElementById('className').value;
            const duration = document.getElementById('duration').value;

            if (!userEmail) {
                alert('Please enter your email');
                return;
            }

            if (!className) {
                alert('Please enter a class name');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(userEmail)) {
                alert('Please enter a valid email address');
                return;
            }

            try {
                const eventId = 'event_' + Date.now();
                const normalizedEmail = userEmail.toLowerCase();

                currentEvent = {
                    id: eventId,
                    name: className,
                    duration: duration,
                    ownerEmail: normalizedEmail,
                    createdAt: new Date().toISOString()
                };

                await setDoc(doc(db, 'events', eventId), currentEvent);
                console.log("Event saved to Firebase:", eventId);

                // Save user email for convenience
                saveUserEmail(normalizedEmail);

                // Generate share link
                const baseUrl = window.location.href.split('?')[0];
                const shareLink = `${baseUrl}?event=${eventId}&view=student`;
                document.getElementById('shareLink').value = shareLink;

                // Display event info
                document.getElementById('eventName').textContent = className;
                document.getElementById('displayEventId').textContent = eventId;

                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';

                listenForResponses();

            } catch (error) {
                console.error("Error creating event:", error);
                alert('Error creating event: ' + error.message);
            }
        }

        function listenForResponses() {
            if (!currentEvent) return;

            const q = query(collection(db, 'responses'), where('eventId', '==', currentEvent.id));

            onSnapshot(q, (snapshot) => {
                const count = snapshot.size;
                document.getElementById('responseCount').textContent = count;
                console.log("Live response count:", count);
            });
        }

        function changeDay(direction) {
            currentDayIndex += direction;

            if (currentDayIndex < 0) currentDayIndex = days.length - 1;
            if (currentDayIndex >= days.length) currentDayIndex = 0;

            document.getElementById('currentDay').textContent = days[currentDayIndex];
            generateTimeSlotsForDay();
        };

        function generateTimeSlotsForDay() {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';

            const grid = document.createElement('div');
            grid.className = 'time-slots-grid';

            const currentDay = days[currentDayIndex];

            timeSlots.forEach((slot, index) => {
                const slotElement = document.createElement('div');
                slotElement.className = 'time-slot';
                slotElement.textContent = slot.time;
                slotElement.dataset.index = index;

                if (selectedSlots[currentDay].includes(slot.startHour)) {
                    slotElement.classList.add('selected');
                }

                slotElement.onclick = function() {
                    this.classList.toggle('selected');
                    const hour = timeSlots[index].startHour;

                    if (this.classList.contains('selected')) {
                        if (!selectedSlots[currentDay].includes(hour)) {
                            selectedSlots[currentDay].push(hour);
                        }
                    } else {
                        selectedSlots[currentDay] = selectedSlots[currentDay].filter(h => h !== hour);
                    }

                    console.log("Selected slots for", currentDay + ":", selectedSlots[currentDay]);
                };

                grid.appendChild(slotElement);
            });

            container.appendChild(grid);
        }

        async function submitAvailability() {
            const studentName = document.getElementById('studentName').value.trim();

            if (!studentName) {
                alert('Please enter your name');
                return;
            }

            const hasSelectedSlots = days.some(day => selectedSlots[day].length > 0);
            if (!hasSelectedSlots) {
                alert('Please select at least one time slot');
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('event');

            if (!eventId) {
                alert('Invalid event link');
                return;
            }

            try {
                // Check if student has already submitted
                const q = query(
                    collection(db, 'responses'),
                    where('eventId', '==', eventId),
                    where('studentName', '==', studentName)
                );
                const existingResponses = await getDocs(q);

                // Delete old responses for this student
                const deletePromises = [];
                existingResponses.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);

                // Add new response
                await addDoc(collection(db, 'responses'), {
                    eventId: eventId,
                    studentName: studentName,
                    availability: selectedSlots,
                    submittedAt: new Date().toISOString()
                });

                const isUpdate = existingResponses.size > 0;
                document.getElementById('confirmation').innerHTML = isUpdate
                    ? '<p>‚úÖ Your availability has been updated successfully!</p>'
                    : '<p>‚úÖ Thank you! Your availability has been recorded.</p>';
                document.getElementById('confirmation').style.display = 'block';

                setTimeout(() => {
                    document.getElementById('studentName').value = '';
                    days.forEach(day => {
                        selectedSlots[day] = [];
                    });
                    generateTimeSlotsForDay();
                    document.getElementById('confirmation').style.display = 'none';
                }, 3000);

            } catch (error) {
                console.error("Error submitting availability:", error);
                alert('Error submitting availability: ' + error.message);
            }
        }

        async function viewResults() {
            if (!currentEvent) {
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('event');
                if (eventId) {
                    await loadExistingEvent(eventId);
                }
            }
            calculateResults();
        };

        window.calculateResults = async function() {
            const eventId = currentEvent ? currentEvent.id : new URLSearchParams(window.location.search).get('event');

            if (!eventId) {
                alert('No event selected');
                return;
            }

            try {
                const q = query(collection(db, 'responses'), where('eventId', '==', eventId));
                const snapshot = await getDocs(q);
                const responses = snapshot.docs.map(doc => doc.data());

                displayCalculatedResults(responses);

            } catch (error) {
                console.error("Error calculating results:", error);
                alert('Error loading results: ' + error.message);
            }
        }

        function displayCalculatedResults(responses) {
            const slotCounts = {};
            const totalStudents = responses.length;

            document.getElementById('totalResponses').textContent = totalStudents;

            if (totalStudents === 0) {
                document.getElementById('resultsContainer').innerHTML = '<p>No responses yet. Share the link with your students!</p>';
                document.getElementById('step2').style.display = 'none';
                document.getElementById('resultsView').style.display = 'block';
                return;
            }

            // Prepare student list with their availability details
            const studentListData = responses.map(response => {
                const totalSlots = days.reduce((sum, day) => {
                    return sum + (response.availability[day] ? response.availability[day].length : 0);
                }, 0);

                return {
                    name: response.studentName,
                    submittedAt: response.submittedAt,
                    totalSlots: totalSlots
                };
            });

            // Sort students by name
            studentListData.sort((a, b) => a.name.localeCompare(b.name));

            // Display student list
            displayStudentList(studentListData);

            days.forEach(day => {
                timeSlots.forEach(slot => {
                    const key = `${day}_${slot.startHour}`;
                    slotCounts[key] = {
                        count: 0,
                        students: []
                    };
                });
            });

            responses.forEach(response => {
                days.forEach(day => {
                    if (response.availability[day]) {
                        response.availability[day].forEach(hour => {
                            const key = `${day}_${hour}`;
                            if (slotCounts[key]) {
                                slotCounts[key].count++;
                                slotCounts[key].students.push(response.studentName);
                            }
                        });
                    }
                });
            });

            const sortedSlots = Object.entries(slotCounts)
                .map(([slotKey, data]) => {
                    const [day, hour] = slotKey.split('_');
                    const slotInfo = timeSlots.find(s => s.startHour == hour);
                    return {
                        day: day,
                        time: slotInfo.time,
                        startHour: parseInt(hour),
                        count: data.count,
                        students: data.students,
                        percentage: (data.count / totalStudents * 100).toFixed(1)
                    };
                })
                .filter(slot => slot.count > 0)
                .sort((a, b) => b.count - a.count);

            displayResults(sortedSlots, totalStudents);
        }

        function displayStudentList(studentListData) {
            const studentListContainer = document.getElementById('studentList');
            studentListContainer.innerHTML = '';

            studentListData.forEach((student, index) => {
                const studentItem = document.createElement('div');
                studentItem.style.cssText = 'padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border-left: 4px solid #667eea;';

                studentItem.innerHTML = `
                    <strong>${index + 1}. ${student.name}</strong>
                    <span style="color: #666; font-size: 0.9em; margin-left: 10px;">
                        ‚Ä¢ ${student.totalSlots} time slots selected
                    </span>
                    <div style="font-size: 0.8em; color: #999; margin-top: 3px;">
                        Submitted: ${new Date(student.submittedAt).toLocaleString()}
                    </div>
                `;

                studentListContainer.appendChild(studentItem);
            });
        }

        function displayResults(slots, totalStudents) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            document.getElementById('step2').style.display = 'none';
            document.getElementById('resultsView').style.display = 'block';

            if (slots.length === 0) {
                container.innerHTML = '<p>No common time slots found. Students may have selected different times.</p>';
                return;
            }

            const topSlots = slots.slice(0, 10);

            topSlots.forEach((slot, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${index === 0 ? 'best' : ''}`;

                const studentNames = slot.students.length > 0
                    ? `<div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <strong>Available students:</strong> ${slot.students.join(', ')}
                       </div>`
                    : '';

                resultItem.innerHTML = `
                    <h3>${slot.day} | ${slot.time}</h3>
                    <div class="availability-count">${slot.count} out of ${totalStudents} students available (${slot.percentage}%)</div>
                    ${index === 0 ? '<p>üèÜ <strong>Best time slot recommended!</strong></p>' : ''}
                    ${studentNames}
                `;

                container.appendChild(resultItem);
            });
        }

        function copyLink() {
            const linkInput = document.getElementById('shareLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // For mobile devices

            // Modern clipboard API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    alert('Link copied to clipboard! Send this to your students.');
                }).catch(() => {
                    // Fallback
                    document.execCommand('copy');
                    alert('Link copied to clipboard! Send this to your students.');
                });
            } else {
                // Fallback for older browsers
                document.execCommand('copy');
                alert('Link copied to clipboard! Send this to your students.');
            }
        }

        function goBackToEvent() {
            document.getElementById('resultsView').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
        }

        function resetApp() {
            if (currentEvent) {
                const confirmReset = confirm('Are you sure you want to go back to the home page?');
                if (!confirmReset) return;
            }

            window.history.replaceState({}, document.title, window.location.pathname);
            document.getElementById('step1').style.display = 'block';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('studentView').style.display = 'none';
            document.getElementById('resultsView').style.display = 'none';
            currentEvent = null;

            document.getElementById('className').value = '';
            document.getElementById('existingEventId').value = '';
            selectedSlots = {};
            days.forEach(day => {
                selectedSlots[day] = [];
            });

            // Clear event history display
            document.getElementById('eventHistory').innerHTML = '';
        }

        async function loadExistingEvent(eventId) {
            try {
                const eventDoc = await getDoc(doc(db, 'events', eventId));

                if (eventDoc.exists()) {
                    currentEvent = { id: eventDoc.id, ...eventDoc.data() };

                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'block';

                    // Display event info
                    document.getElementById('eventName').textContent = currentEvent.name || 'Event';
                    document.getElementById('displayEventId').textContent = currentEvent.id;

                    const baseUrl = window.location.href.split('?')[0];
                    const shareLink = `${baseUrl}?event=${currentEvent.id}&view=student`;
                    document.getElementById('shareLink').value = shareLink;

                    listenForResponses();
                } else {
                    console.error("Event not found");
                    alert("Event not found. Please check your Event ID.");
                }
            } catch (error) {
                console.error("Error loading event:", error);
                alert("Error loading event: " + error.message);
            }
        }

        async function accessExistingEvent() {
            const eventId = document.getElementById('existingEventId').value.trim();

            if (!eventId) {
                alert('Please enter an Event ID');
                return;
            }

            try {
                await loadExistingEvent(eventId);
            } catch (error) {
                console.error("Error accessing event:", error);
                alert("Could not access event. Please check your Event ID.");
            }
        }

        function initApp() {
            // Load saved user email
            loadUserEmail();

            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');
            const eventId = urlParams.get('event');

            if (view === 'student') {
                document.getElementById('step1').style.display = 'none';
                document.getElementById('studentView').style.display = 'block';

                if (eventId) {
                    document.getElementById('eventInfo').textContent = `Event ID: ${eventId} - Please mark your available times`;
                }

                generateTimeSlotsForDay();

            } else if (eventId) {
                loadExistingEvent(eventId);
            } else {
                resetApp();
            }
        }

        function setupEventListeners() {
            document.getElementById('createEventBtn')?.addEventListener('click', createClassEvent);
            document.getElementById('loadHistoryBtn')?.addEventListener('click', () => {
                const email = document.getElementById('historyEmail').value.trim();
                loadUserEvents(email);
            });
            document.getElementById('accessEventBtn')?.addEventListener('click', accessExistingEvent);
            document.getElementById('copyLinkBtn')?.addEventListener('click', copyLink);
            document.getElementById('viewResultsBtn')?.addEventListener('click', viewResults);
            document.getElementById('resetAppBtn')?.addEventListener('click', resetApp);
            document.getElementById('prevDayBtn')?.addEventListener('click', () => changeDay(-1));
            document.getElementById('nextDayBtn')?.addEventListener('click', () => changeDay(1));
            document.getElementById('submitAvailabilityBtn')?.addEventListener('click', submitAvailability);
            document.getElementById('goBackBtn')?.addEventListener('click', goBackToEvent);
            document.getElementById('showStudentListBtn')?.addEventListener('click', () => {
                const container = document.getElementById('studentListContainer');
                const btn = document.getElementById('showStudentListBtn');
                if (container.style.display === 'none') {
                    container.style.display = 'block';
                    btn.textContent = 'üë• Hide Student List';
                } else {
                    container.style.display = 'none';
                    btn.textContent = 'üë• Show All Students';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            initApp();
        });
    </script>
</body>
</html>
