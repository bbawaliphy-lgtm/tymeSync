<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TimeSync - Find Common Class Time</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height:100vh; padding:20px;
    }
    .container {
      max-width:1000px; margin:0 auto; background:#fff;
      border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,.12);
      padding:30px;
    }
    header { text-align:center; margin-bottom:24px; }
    header h1 { color:#333; font-size:2.4rem; margin-bottom:6px; }
    header p { color:#666; }

    .step { margin-bottom:30px; }
    .step h2 { color:#333; margin-bottom:14px; border-bottom:2px solid #667eea; padding-bottom:8px; }

    .form-group { margin-bottom:14px; }
    label { display:block; margin-bottom:6px; font-weight:600; color:#333; }
    input[type="text"], input[type="email"], input[type="password"], textarea, select {
      width:100%; padding:12px; border:2px solid #ddd; border-radius:10px; font-size:16px;
      transition: border-color .2s ease;
    }
    input:focus, textarea:focus, select:focus { outline:none; border-color:#667eea; background:#f7f9ff; }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff; border:none; padding:10px 18px; border-radius:10px; font-size:15px; cursor:pointer;
      transition: transform .15s ease;
      margin:4px 6px 4px 0;
    }
    button:hover { transform: translateY(-1px); }
    button.secondary { background:#6c757d; }

    .share-box { display:flex; gap:10px; margin-bottom:12px; }
    .share-box input { flex:1; cursor:text; }

    .live-stats { background:#e7f3ff; border:1px solid #b3d9ff; padding:14px; border-radius:10px; margin:16px 0; text-align:center; }

    .event-info { background:#e7f3ff; border:1px solid #b3d9ff; padding:12px; border-radius:10px; margin:12px 0; text-align:center; }

    .time-slots-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:10px; margin-bottom:14px; }
    .time-slot { padding:12px 8px; border:2px solid #ddd; border-radius:8px; text-align:center; cursor:pointer; transition: all .2s; font-size:.95rem; }
    .time-slot:hover { border-color:#667eea; background:#f0f4ff; }
    .time-slot.selected { background:#667eea; color:#fff; border-color:#667eea; }

    .result-item { background:#f8f9fa; border:2px solid #e9ecef; border-radius:12px; padding:18px; margin-bottom:12px; }
    .result-item.best { border-color:#28a745; background:#d4edda; }
    .availability-count { font-weight:700; color:#28a745; }

    .event-history-item { background:#f8f9fa; border:2px solid #e9ecef; border-radius:10px; padding:14px; margin-bottom:10px; transition:all .2s; }
    .event-history-item:hover { border-color:#667eea; background:#f0f4ff; transform: translateX(3px); }

    .event-history-actions { display:flex; gap:8px; margin-top:8px; }

    @media (max-width: 768px) { .container{ padding:16px; } .time-slots-grid{ grid-template-columns: repeat(3,1fr);} }
    @media (max-width: 480px) { .time-slots-grid{ grid-template-columns: repeat(2,1fr);} }
  </style>
</head>
<body>

  <!-- Admin Auth Gate -->
  <div id="authGate" style="max-width: 520px; margin: 20px auto; display:none;">
    <div style="background:white; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,0.08); padding:22px;">
      <h2 style="margin-bottom:10px; color:#333;">Admin Login</h2>
      <p style="color:#666; margin-bottom:12px;">Sign in to create events and view results.</p>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="adminEmail" placeholder="you@example.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="adminPassword" placeholder="Min 6 characters">
      </div>
      <button id="loginBtn">Login</button>
      <button id="registerBtn" class="secondary" title="One-time setup">Register</button>
    </div>
  </div>

  <div class="container">
    <header>
      <h1>üïê TimeSync</h1>
      <p>Find the perfect common time for your online classes</p>
      <div id="adminBar" style="display:none; margin-top:10px;">
        <span id="adminWho" style="color:#444; font-size:0.95em;"></span>
        <button id="logoutBtn" class="secondary" style="padding:6px 10px; margin-left:10px;">Logout</button>
      </div>
    </header>

    <!-- Step 1: Create Event -->
    <div id="step1" class="step" style="display:none;">
      <h2>Step 1: Create Your Class Event</h2>
      <div class="form-group">
        <label>Your Email (to access your events from any device):</label>
        <input type="email" id="userEmail" placeholder="e.g., teacher@example.com">
      </div>
      <div class="form-group">
        <label>Class/Batch Name:</label>
        <input type="text" id="className" placeholder="e.g., Batch 2025 Physics" required>
      </div>
      <div class="form-group">
        <label>Note for Students (optional):</label>
        <textarea id="eventNote" placeholder="Example: This schedule is for extra doubt-clearing session." style="min-height:84px;"></textarea>
      </div>
      <div class="form-group">
        <label>Session Duration:</label>
        <select id="duration">
          <option value="1">1 hour</option>
          <option value="1.5">1.5 hours</option>
          <option value="2">2 hours</option>
        </select>
      </div>
      <button id="createEventBtn">Create Event & Get Share Link</button>

      <!-- Event History -->
      <div id="eventHistorySection" style="margin-top: 28px; padding-top: 22px; border-top: 2px solid #e9ecef;">
        <h3 style="margin-bottom: 10px; color: #666;">üìã Your Events</h3>
        <div class="form-group">
          <label>Enter your email to view your events:</label>
          <input type="email" id="historyEmail" placeholder="e.g., teacher@example.com">
          <button id="loadHistoryBtn" style="margin-top: 8px;">Load My Events</button>
        </div>
        <div id="eventHistory" style="margin-top: 12px;"></div>
      </div>

      <div style="margin-top: 22px; padding-top: 20px; border-top: 2px solid #e9ecef;">
        <h3 style="margin-bottom: 10px; color: #666;">üîç Access Event by ID</h3>
        <p style="color:#666; margin-bottom:10px; font-size:.95em;">Enter Event ID shared by someone else</p>
        <div class="form-group">
          <input type="text" id="existingEventId" placeholder="e.g., event_1730544000000">
        </div>
        <button id="accessEventBtn" class="secondary">Access Event</button>
      </div>
    </div>

    <!-- Step 2: Share -->
    <div id="step2" class="step" style="display:none;">
      <h2>Step 2: Share This Link With Students</h2>
      <div class="event-info" style="margin-bottom: 14px;">
        <h3 id="eventName" style="margin-bottom: 6px;"></h3>
        <p><strong>Event ID:</strong> <span id="displayEventId"></span></p>
        <p style="font-size: 0.9em; color: #666; margin-top: 5px;">Save this Event ID to access responses from any device!</p>
      </div>

      <div class="share-box">
        <input type="text" id="shareLink" readonly>
        <button id="copyLinkBtn">Copy Link</button>
        <button id="whatsappShareBtn" title="Share to WhatsApp">Share to WhatsApp</button>
      </div>

      <div class="live-stats">
        <h3>üìä Live Responses: <span id="responseCount">0</span> students</h3>
      </div>

      <button id="viewResultsBtn">View Live Results</button>
      <button id="resetAppBtn" class="secondary">Create New Event</button>
    </div>

    <!-- Student View -->
    <div id="studentView" class="step" style="display:none;">
      <h2>Mark Your Available Times</h2>
      <p style="margin:10px 0; font-size:0.95em; color:#444;">
        üí° Use the <em>same name and phone number</em> for updates. This avoids duplicate entries.
      </p>
      <p class="event-info" id="eventInfo"></p>

      <div class="day-navigation">
        <button id="prevDayBtn">‚Üê Previous Day</button>
        <span id="currentDay">Monday</span>
        <button id="nextDayBtn">Next Day ‚Üí</button>
      </div>

      <div class="calendar">
        <h3>Select your available time slots (6:00 AM - 11:00 PM):</h3>
        <div class="time-slots" id="timeSlots"></div>
      </div>

      <div class="form-group">
        <label>Your Name:</label>
        <input type="text" id="studentName" placeholder="Enter your name" required>
      </div>
      <div class="form-group">
        <label>Your Phone Number:</label>
        <input type="text" id="studentPhone" placeholder="e.g., 9876543210" required>
      </div>
      <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
        ‚úèÔ∏è Use the same name and number if you want to update your availability later
      </p>

      <button id="submitAvailabilityBtn">Submit My Availability</button>
      <div id="confirmation" class="confirmation" style="display:none;">
        <p>‚úÖ Thank you! Your availability has been recorded.</p>
      </div>
      <div id="editNotification" class="event-info" style="display:none; margin-top: 20px;">
        <p>‚úèÔ∏è You have already submitted your availability. You can update it by submitting again.</p>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsView" class="step" style="display:none;">
      <h2>Best Time Slots for Your Class</h2>
      <div class="event-info" id="adminEventNote"></div>

      <div class="live-stats">
        <h3>üìä Total Responses: <span id="totalResponses">0</span> students</h3>
      </div>

      <div style="margin-bottom: 20px;">
        <button id="showStudentListBtn" class="secondary" style="margin: 10px 0;">üë• Show All Students</button>
        <div id="studentListContainer" style="display:none; background:#f8f9fa; padding:16px; border-radius:10px; margin-top: 10px;">
          <h3 style="margin-bottom: 10px;">Students Who Responded:</h3>
          <div id="studentList"></div>
        </div>
      </div>

      <div id="resultsContainer"></div>
      <button id="goBackBtn" class="secondary">Back to Event</button>
    </div>
  </div>

  <footer style="max-width:1000px; margin:24px auto 0; text-align:center; color:#f0f0f0; font-size:0.95em;">
    ¬© 2025 TimeSync - Developed by <strong>Biplab Bawali</strong>. All Rights Reserved.
  </footer>

  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, addDoc,
      onSnapshot, query, where, getDocs, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAz9_ZMs3pHCqcJsdiWNuozaFU30ISNmmA",
      authDomain: "timesync-app-4193b.firebaseapp.com",
      projectId: "timesync-app-4193b",
      storageBucket: "timesync-app-4193b.firebasestorage.app",
      messagingSenderId: "813960878803",
      appId: "1:813960878803:web:19e7b9f46f2d94b7239226"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const ADMIN_ALLOWLIST = [
  "bbawaliphy@gmail.com",
  "titir95biplab@gmail.com"
];


    // UI helpers
    function show(el){ if (el) el.style.display='block'; }
    function hide(el){ if (el) el.style.display='none'; }

    // State
    let currentEvent = null;
    let currentDayIndex = 0;
    const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
    let selectedSlots = {}; days.forEach(d => selectedSlots[d] = []);

    // Local email convenience
    function saveUserEmail(email){ localStorage.setItem('timesync_user_email', email); }
    function loadUserEmail(){
      const email = localStorage.getItem('timesync_user_email');
      if (email){
        const ue = document.getElementById('userEmail');
        const he = document.getElementById('historyEmail');
        if (ue) ue.value = email;
        if (he) he.value = email;
      }
    }

    function showAdminUI(user){
      if (!user || !ADMIN_ALLOWLIST.includes(user.email.toLowerCase())){
        hide(document.getElementById('step1'));
        hide(document.getElementById('step2'));
        hide(document.getElementById('resultsView'));
        show(document.getElementById('authGate'));
        hide(document.getElementById('adminBar'));
        return;
      }
      document.getElementById('adminWho').textContent = `Signed in as ${user.email}`;
      show(document.getElementById('adminBar'));
      show(document.getElementById('step1'));
      hide(document.getElementById('authGate'));
      // prefill
      const email = user.email.toLowerCase();
      const ue = document.getElementById('userEmail');
      const he = document.getElementById('historyEmail');
      if (ue) ue.value = email;
      if (he) he.value = email;
      saveUserEmail(email);
    }

    function hideAdminUI(){
      hide(document.getElementById('adminBar'));
      hide(document.getElementById('step1'));
      hide(document.getElementById('step2'));
      hide(document.getElementById('resultsView'));
      show(document.getElementById('authGate'));
    }

    // Events history
    async function loadUserEvents(email){
      if (!email){ alert('Please enter your email'); return; }
      const normalizedEmail = email.toLowerCase().trim();
      try{
        const qy = query(collection(db,'events'), where('ownerEmail','==', normalizedEmail));
        const snapshot = await getDocs(qy);
        const events = snapshot.docs.map(d => ({id:d.id, ...d.data()}));
        events.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
        displayEventHistory(events);
        saveUserEmail(normalizedEmail);
      }catch(err){
        console.error(err);
        alert('Error loading events: ' + err.message);
      }
    }

    function displayEventHistory(events){
      const historyContainer = document.getElementById('eventHistory');
      if (!events || events.length === 0){
        historyContainer.innerHTML = '<p style="color:#666; padding:12px; text-align:center;">No events found for this email.</p>';
        return;
      }
      historyContainer.innerHTML = '';
      const basePath = window.location.origin + window.location.pathname;

      events.forEach(evt => {
        const wrapper = document.createElement('div');
        wrapper.className = 'event-history-item';

        const info = document.createElement('div');
        const shareLink = `${basePath}?event=${evt.id}&view=student`;
        info.innerHTML = `
          <h4>${evt.name}</h4>
          <p>Created: ${new Date(evt.createdAt).toLocaleString()}</p>
          <p style="font-size:0.85em; color:#444;">Event ID: <strong>${evt.id}</strong></p>
          ${evt.note ? `<p style="color:#777; margin-top:5px;">üìù ${evt.note}</p>` : ''}
          <div class="event-history-actions">
            <input type="text" value="${shareLink}" readonly style="flex:1; padding:8px; border:1px solid #ccc; border-radius:6px; font-size:.9em;" />
            <button class="copyShareLinkBtn" data-link="${shareLink}">Copy Link</button>
            <button class="whShare" data-link="${shareLink}" data-text="${encodeURIComponent('TimeSync - ' + (evt.name||'Class'))}">WhatsApp</button>
          </div>
        `;
        info.onclick = (e) => {
          // avoid triggering when clicking buttons/inputs
          const tag = (e.target.tagName||'').toLowerCase();
          if (tag === 'button' || tag === 'input') return;
          loadExistingEvent(evt.id);
        };

        wrapper.appendChild(info);
        historyContainer.appendChild(wrapper);
      });
    }

    // Timeslots
    function formatTime(hour){
      if (hour === 0) return '12 AM';
      if (hour === 12) return '12 PM';
      if (hour < 12) return `${hour} AM`;
      return `${hour-12} PM`;
    }
    function generateTimeSlots(){
      const slots = [];
      for (let hour=6; hour<=23; hour++){
        const timeString = formatTime(hour);
        const nh = (hour===23) ? 0 : hour+1;
        const nextTimeString = formatTime(nh);
        slots.push({ time:`${timeString} - ${nextTimeString}`, startHour:hour });
      }
      return slots;
    }
    const timeSlots = generateTimeSlots();

    // Create event
    async function createClassEvent(){
      const userEmail = (document.getElementById('userEmail').value||'').trim();
      const className = document.getElementById('className').value;
      const eventNote = (document.getElementById('eventNote').value||'').trim();
      const duration = document.getElementById('duration').value;

      if (!userEmail){ alert('Please enter your email'); return; }
      if (!className){ alert('Please enter a class name'); return; }
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(userEmail)){ alert('Please enter a valid email address'); return; }

      try{
        const eventId = 'event_' + Date.now();
        const normalizedEmail = userEmail.toLowerCase();
        currentEvent = {
          id: eventId,
          name: className,
          note: eventNote,
          duration: duration,
          ownerEmail: (auth.currentUser?.email || normalizedEmail).toLowerCase(),
          createdAt: new Date().toISOString()
        };
        await setDoc(doc(db,'events',eventId), currentEvent);

        const baseUrl = window.location.href.split('?')[0];
        const shareLink = `${baseUrl}?event=${eventId}&view=student`;
        document.getElementById('shareLink').value = shareLink;
        document.getElementById('eventName').textContent = className;
        document.getElementById('displayEventId').textContent = eventId;

        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';

        listenForResponses();
      }catch(err){
        console.error(err);
        alert('Error creating event: ' + err.message);
      }
    }

    function listenForResponses(){
      if (!currentEvent) return;
      const qy = query(collection(db,'responses'), where('eventId','==', currentEvent.id));
      onSnapshot(qy, (snap) => {
        document.getElementById('responseCount').textContent = String(snap.size);
      });
    }

    function changeDay(dir){
      currentDayIndex += dir;
      if (currentDayIndex < 0) currentDayIndex = days.length - 1;
      if (currentDayIndex >= days.length) currentDayIndex = 0;
      document.getElementById('currentDay').textContent = days[currentDayIndex];
      generateTimeSlotsForDay();
    }

    function generateTimeSlotsForDay(){
      const container = document.getElementById('timeSlots');
      container.innerHTML = '';
      const grid = document.createElement('div');
      grid.className = 'time-slots-grid';
      const currentDay = days[currentDayIndex];

      timeSlots.forEach((slot, idx) => {
        const el = document.createElement('div');
        el.className = 'time-slot';
        el.textContent = slot.time;
        el.dataset.index = idx;
        if ((selectedSlots[currentDay]||[]).includes(slot.startHour)){ el.classList.add('selected'); }
        el.onclick = function(){
          this.classList.toggle('selected');
          const hour = timeSlots[idx].startHour;
          if (this.classList.contains('selected')){
            if (!selectedSlots[currentDay].includes(hour)) selectedSlots[currentDay].push(hour);
          }else{
            selectedSlots[currentDay] = (selectedSlots[currentDay]||[]).filter(h => h !== hour);
          }
        };
        grid.appendChild(el);
      });
      container.appendChild(grid);
    }

    async function submitAvailability(){
      const studentName = (document.getElementById('studentName').value||'').trim();
      const studentPhone = (document.getElementById('studentPhone').value||'').trim();
      if (!studentPhone){ alert('Please enter your phone number'); return; }
      if (!studentName){ alert('Please enter your name'); return; }

      const hasSelected = days.some(day => (selectedSlots[day]||[]).length > 0);
      if (!hasSelected){ alert('Please select at least one time slot'); return; }

      const urlParams = new URLSearchParams(window.location.search);
      const eventId = urlParams.get('event');
      if (!eventId){ alert('Invalid event link'); return; }

      try{
        // remove previous with same phone
        const qy = query(collection(db,'responses'), where('eventId','==', eventId), where('studentPhone','==', studentPhone));
        const existing = await getDocs(qy);
        await Promise.all(existing.docs.map(d => deleteDoc(d.ref)));

        await addDoc(collection(db,'responses'), {
          eventId, studentName, studentPhone,
          availability: selectedSlots,
          submittedAt: new Date().toISOString()
        });

        const isUpdate = existing.size > 0;
        document.getElementById('confirmation').innerHTML = isUpdate
          ? '<p>‚úÖ Your availability has been updated successfully!</p>'
          : '<p>‚úÖ Thank you! Your availability has been recorded.</p>';
        document.getElementById('confirmation').style.display = 'block';

        setTimeout(() => {
          document.getElementById('studentName').value = '';
          days.forEach(d => selectedSlots[d] = []);
          generateTimeSlotsForDay();
          document.getElementById('confirmation').style.display = 'none';
        }, 2500);
      }catch(err){
        console.error(err);
        alert('Error submitting availability: ' + err.message);
      }
    }

    async function viewResults(){
      if (!currentEvent){
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('event');
        if (eventId) await loadExistingEvent(eventId);
      }
      calculateResults();
    }

    window.calculateResults = async function(){
      const eventId = currentEvent ? currentEvent.id : new URLSearchParams(window.location.search).get('event');
      if (!eventId){ alert('No event selected'); return; }
      try{
        const qy = query(collection(db,'responses'), where('eventId','==', eventId));
        const snap = await getDocs(qy);
        const responses = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        displayCalculatedResults(responses);
      }catch(err){
        console.error(err);
        alert('Error loading results: ' + err.message);
      }
    }

    function displayCalculatedResults(responses){
      const slotCounts = {};
      const totalStudents = responses.length;
      document.getElementById('totalResponses').textContent = String(totalStudents);

      if (totalStudents === 0){
        document.getElementById('resultsContainer').innerHTML = '<p>No responses yet. Share the link with your students!</p>';
        document.getElementById('step2').style.display = 'none';
        document.getElementById('resultsView').style.display = 'block';
        return;
      }

      const studentListData = responses.map(r => {
        const totalSlots = days.reduce((sum, d) => sum + ((r.availability[d]||[]).length), 0);
        return { id:r.id, name:r.studentName, phone:r.studentPhone, submittedAt:r.submittedAt, totalSlots };
      }).sort((a,b) => a.name.localeCompare(b.name));

      displayStudentList(studentListData);

      days.forEach(day => {
        timeSlots.forEach(s => {
          const key = `${day}_${s.startHour}`;
          slotCounts[key] = { count:0, students:[] };
        });
      });

      responses.forEach(r => {
        days.forEach(day => {
          (r.availability[day]||[]).forEach(hour => {
            const key = `${day}_${hour}`;
            if (slotCounts[key]){
              slotCounts[key].count++;
              slotCounts[key].students.push(r.studentName);
            }
          });
        });
      });

      const sorted = Object.entries(slotCounts).map(([slotKey, data]) => {
        const [day, hour] = slotKey.split('_');
        const slotInfo = timeSlots.find(s => s.startHour == hour);
        return {
          day, time: slotInfo.time, startHour: parseInt(hour,10),
          count: data.count, students: data.students,
          percentage: ((data.count / totalStudents) * 100).toFixed(1)
        };
      }).filter(x => x.count > 0).sort((a,b) => b.count - a.count);

      displayResults(sorted, totalStudents);
    }

    function displayStudentList(list){
      const container = document.getElementById('studentList');
      container.innerHTML = '';
      list.forEach((s, idx) => {
        const item = document.createElement('div');
        item.style.cssText = 'padding:10px; margin-bottom:8px; background:white; border-radius:8px; border-left:4px solid #667eea; display:flex; justify-content:space-between; align-items:center;';
        item.innerHTML = `
          <div>
            <strong>${idx+1}. ${s.name}</strong>
            <span style="color:#999; font-size:0.85em;"> (${s.phone||''})</span>
            <span style="color:#666; font-size:0.9em; margin-left:10px;">‚Ä¢ ${s.totalSlots} slots</span>
            <div style="font-size:0.8em; color:#999; margin-top:3px;">
              Submitted: ${new Date(s.submittedAt).toLocaleString()}
            </div>
          </div>
          <button class="delete-btn" data-id="${s.id}">üóëÔ∏è Delete</button>
        `;
        item.querySelector('.delete-btn').onclick = async () => {
          if (confirm(`Remove response of ${s.name}?`)){
            await deleteDoc(doc(db,'responses', s.id));
            calculateResults();
          }
        };
        container.appendChild(item);
      });
    }

    function displayResults(slots, total){
      const container = document.getElementById('resultsContainer');
      container.innerHTML = '';
      document.getElementById('step2').style.display = 'none';
      document.getElementById('resultsView').style.display = 'block';

      if (slots.length === 0){
        container.innerHTML = '<p>No common time slots found. Students may have selected different times.</p>';
        return;
      }

      const top = slots.slice(0,10);
      top.forEach((slot, idx) => {
        const card = document.createElement('div');
        card.className = 'result-item ' + (idx===0 ? 'best' : '');
        const names = slot.students.length
          ? `<div style="margin-top:8px; font-size:.9em; color:#666;"><strong>Available students:</strong> ${slot.students.join(', ')}</div>`
          : '';
        card.innerHTML = `
          <h3>${slot.day} | ${slot.time}</h3>
          <div class="availability-count">${slot.count} out of ${total} students available (${slot.percentage}%)</div>
          ${idx===0 ? '<p>üèÜ <strong>Best time slot recommended!</strong></p>' : ''}
          ${names}
        `;
        container.appendChild(card);
      });
    }

    function copyLink(){
      const el = document.getElementById('shareLink');
      el.select(); el.setSelectionRange(0, 99999);
      if (navigator.clipboard){
        navigator.clipboard.writeText(el.value).then(() => alert('Link copied to clipboard!'));
      }else{
        document.execCommand('copy'); alert('Link copied to clipboard!');
      }
    }

    function shareToWhatsApp(link, text){
      const msg = (text || 'Join the TimeSync event') + '%0A' + encodeURIComponent(link);
      const url = 'https://wa.me/?text=' + msg;
      window.open(url, '_blank');
    }

    function goBackToEvent(){
      document.getElementById('resultsView').style.display = 'none';
      document.getElementById('step2').style.display = 'block';
    }

    function resetApp(){
      window.history.replaceState({}, document.title, window.location.pathname);
      document.getElementById('step1').style.display = 'block';
      document.getElementById('step2').style.display = 'none';
      document.getElementById('studentView').style.display = 'none';
      document.getElementById('resultsView').style.display = 'none';
      currentEvent = null;
      document.getElementById('className').value = '';
      document.getElementById('existingEventId').value = '';
      selectedSlots = {}; days.forEach(d => selectedSlots[d] = []);
      document.getElementById('eventHistory').innerHTML = '';
    }

    async function loadExistingEvent(eventId){
      try{
        const ev = await getDoc(doc(db,'events', eventId));
        if (!ev.exists()){ alert('Event not found'); return; }
        currentEvent = { id: ev.id, ...ev.data() };

        // Admin info
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
        document.getElementById('eventName').textContent = currentEvent.name || 'Event';
        document.getElementById('displayEventId').textContent = currentEvent.id;
        document.getElementById('adminEventNote').innerHTML = currentEvent.note ? (`<strong>Note:</strong> ${currentEvent.note}`) : '';

        const baseUrl = window.location.href.split('?')[0];
        document.getElementById('shareLink').value = `${baseUrl}?event=${currentEvent.id}&view=student`;

        // Student info (if studentView visible)
        const studentInfoBlock = document.getElementById('eventInfo');
        if (studentInfoBlock && document.getElementById('studentView').style.display !== 'none'){
          studentInfoBlock.innerHTML = `
            <strong>${currentEvent.name || 'Event'}</strong><br>
            <span style="color:#666;">Created by: ${currentEvent.ownerEmail || 'Unknown'}</span>
            ${currentEvent.note ? `
              <div style="margin-top:10px; padding:10px; background:#f8f9ff; border-left:4px solid #667eea; border-radius:6px;">
                <strong>Note:</strong> ${currentEvent.note}
              </div>` : ''}
          `;
        }

        listenForResponses();
      }catch(err){
        console.error(err);
        alert('Error loading event: ' + err.message);
      }
    }

    async function accessExistingEvent(){
      const eventId = (document.getElementById('existingEventId').value||'').trim();
      if (!eventId){ alert('Please enter an Event ID'); return; }
      await loadExistingEvent(eventId);
    }

    async function initApp(){
      loadUserEmail();

      const params = new URLSearchParams(window.location.search);
      const view = params.get('view');
      const eventId = params.get('event');

      if (view === 'student'){
        hide(document.getElementById('step1'));
        hide(document.getElementById('step2'));
        hide(document.getElementById('resultsView'));
        show(document.getElementById('studentView'));
        if (eventId) await loadExistingEvent(eventId);
        generateTimeSlotsForDay();
        return;
      }

      // Admin route (auth required)
      onAuthStateChanged(auth, (user) => {
        if (user && ADMIN_ALLOWLIST.includes(user.email.toLowerCase())){
          showAdminUI(user);
        }else{
          hideAdminUI();
        }
      });
    }

    function setupEventListeners(){
      // Admin actions
      document.getElementById('createEventBtn')?.addEventListener('click', createClassEvent);
      document.getElementById('loadHistoryBtn')?.addEventListener('click', () => {
        const email = (document.getElementById('historyEmail').value||'').trim();
        loadUserEvents(email);
      });
      document.getElementById('accessEventBtn')?.addEventListener('click', accessExistingEvent);
      document.getElementById('copyLinkBtn')?.addEventListener('click', copyLink);
      document.getElementById('viewResultsBtn')?.addEventListener('click', viewResults);
      document.getElementById('resetAppBtn')?.addEventListener('click', resetApp);

      // Student actions
      document.getElementById('prevDayBtn')?.addEventListener('click', () => changeDay(-1));
      document.getElementById('nextDayBtn')?.addEventListener('click', () => changeDay(1));
      document.getElementById('submitAvailabilityBtn')?.addEventListener('click', submitAvailability);
      document.getElementById('goBackBtn')?.addEventListener('click', goBackToEvent);

      // Show student list toggle
      document.getElementById('showStudentListBtn')?.addEventListener('click', () => {
        const container = document.getElementById('studentListContainer');
        if (container.style.display === 'none'){
          container.style.display = 'block';
          document.getElementById('showStudentListBtn').textContent = 'üë• Hide Students';
        } else {
          container.style.display = 'none';
          document.getElementById('showStudentListBtn').textContent = 'üë• Show All Students';
        }
      });

      // Share to WhatsApp (Step 2)
      document.getElementById('whatsappShareBtn')?.addEventListener('click', () => {
        const link = document.getElementById('shareLink').value;
        const title = 'TimeSync - ' + (document.getElementById('eventName').textContent || 'Class');
        shareToWhatsApp(link, encodeURIComponent(title));
      });

      // Delegate clicks for history list buttons
      document.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList?.contains('copyShareLinkBtn')){
          const link = target.getAttribute('data-link');
          if (navigator.clipboard) { navigator.clipboard.writeText(link).then(()=>alert('‚úÖ Share link copied!')); }
          else { alert('Copy this link: ' + link); }
        }
        if (target.classList?.contains('whShare')){
          const link = target.getAttribute('data-link');
          const text = target.getAttribute('data-text') || 'TimeSync Event';
          shareToWhatsApp(link, text);
        }
      });

      // Auth
      document.getElementById('loginBtn')?.addEventListener('click', async () => {
        const email = (document.getElementById('adminEmail').value||'').trim();
        const password = (document.getElementById('adminPassword').value||'').trim();
        if (!email || !password) return alert('Enter email & password');
        try {
          const cred = await signInWithEmailAndPassword(auth, email, password);
          if (!ADMIN_ALLOWLIST.includes(cred.user.email.toLowerCase())){
            await signOut(auth);
            alert('This account is not authorized for admin access.');
          }
        } catch (e) { alert('Login failed: ' + e.message); }
      });

      document.getElementById('registerBtn')?.addEventListener('click', async () => {
        const email = (document.getElementById('adminEmail').value||'').trim();
        const password = (document.getElementById('adminPassword').value||'').trim();
        if (!email || !password) return alert('Enter email & password');
        if (password.length < 6) return alert('Password must be at least 6 chars');
        try {
          const cred = await createUserWithEmailAndPassword(auth, email, password);
          if (!ADMIN_ALLOWLIST.includes(cred.user.email.toLowerCase())){
            alert('Account created, but this email is not on admin allowlist. Update ADMIN_ALLOWLIST in code to permit admin access.');
          }else{
            alert('Account created. You are now logged in.');
          }
        } catch (e) { alert('Register failed: ' + e.message); }
      });

      document.getElementById('logoutBtn')?.addEventListener('click', async () => { await signOut(auth); });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      initApp();
    });
  </script>
</body>
</html>
